# Development Dockerfile for TremTec (Phoenix) - with hot reload
# Elixir 1.18.4, OTP 28

ARG ELIXIR_VERSION=1.18.4

FROM elixir:${ELIXIR_VERSION}

ENV MIX_ENV=dev \
    LANG=C.UTF-8 \
    SHELL=/bin/bash

RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
      build-essential \
      watchman \
      git \
      curl \
      ca-certificates \
      pkg-config \
      libssl-dev \
      libsqlite3-dev \
      inotify-tools \
      postgresql-client && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Install hex and rebar
RUN mix local.hex --force && \
    mix local.rebar --force

# Copy mix files
COPY mix.exs mix.lock ./
COPY config ./config

# Install dependencies (including dev and test)
RUN mix deps.get

# Copy entire application for development
COPY . .

# Create data directory for SQLite database
RUN mkdir -p /data && chmod 755 /data

ENV DATABASE_PATH=${DATABASE_PATH:-/data/tremtec_dev.db}

EXPOSE 4000

# Run the server with hot reload
CMD ["mix", "phx.server"]
